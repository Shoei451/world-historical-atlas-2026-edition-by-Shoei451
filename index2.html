<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¸–ç•Œå² Atlas - æ”¹å–„ç‰ˆ</title>
<link rel="stylesheet" href="style2.css">
<link rel="icon" href="favicon.png ">
</head>
<body>

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="header">
  <div class="logo">ğŸŒ ä¸–ç•Œå² Atlas</div>
  
  <div class="controls">
    <!-- è¨€èªåˆ‡ã‚Šæ›¿ãˆ -->
    <div class="lang-buttons">
      <button class="btn lang-btn active" data-lang="ja">æ—¥æœ¬èª</button>
      <button class="btn lang-btn" data-lang="en">English</button>
      <button class="btn lang-btn" data-lang="zh">ä¸­æ–‡</button>
    </div>
    
    <!-- å¹´ä»£è¡¨ç¤º -->
    <div class="year-display">
      <div class="year-main" id="yearDisplay">å‰4000å¹´</div>
      <div class="year-sub" id="yearSub"></div>
    </div>
    
    <!-- å¹´ä»£å…¥åŠ› -->
    <div class="year-input-group">
      <input type="number" class="year-input" id="yearInput" placeholder="å¹´ã‚’å…¥åŠ›" min="-4000" max="2019">
      <button class="btn" id="jumpToYear">ç§»å‹•</button>
    </div>
    
    <!-- ã‚ºãƒ¼ãƒ  -->
    <div class="zoom-control">
      <button class="btn" id="zoomOut">âˆ’</button>
      <div class="zoom-slider" id="zoomSlider">
        <div class="zoom-slider-fill" id="zoomFill"></div>
        <div class="zoom-slider-thumb" id="zoomThumb"></div>
      </div>
      <button class="btn" id="zoomIn">+</button>
    </div>
    
    <!-- æ¤œç´¢ -->
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input type="text" class="search-input" id="searchInput" placeholder="å›½ãƒ»äººç‰©ã‚’æ¤œç´¢">
    </div>
    
    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <button class="btn" id="bookmarkBtn">
      <span id="bookmarkIcon">ğŸ”–</span> ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
    </button>
    <button class="btn" id="helpBtn">â“ ãƒ˜ãƒ«ãƒ—</button>
  </div>
</div>

<!-- ãƒãƒƒãƒ— -->
<div class="map-container" id="mapContainer">
  <div class="map-layer" id="mapLayer">
    <div style="padding: 40px; text-align: center; color: #666;">
      <h2>ğŸ—ºï¸ ã“ã“ã«ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªä¸–ç•Œåœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</h2>
      <p style="margin-top: 10px;">å…ƒã®ã‚³ãƒ¼ãƒ‰ã®åœ°å›³ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¦è¡¨ç¤º</p>
      <p style="margin-top: 20px; font-size: 14px;">
        ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒãƒƒãƒ—ç§»å‹• | ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ <br>
        ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã§åœ°åŸŸè©³ç´°ã‚’è¡¨ç¤º
      </p>
    </div>
  </div>
</div>

<!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
<div class="timeline">
  <div class="timeline-bar" id="timelineBar">
    <div class="timeline-cursor" id="timelineCursor"></div>
  </div>
  
  <div class="timeline-controls">
    <button class="btn" id="prevCentury">Â« 100å¹´å‰</button>
    <button class="btn" id="prevDecade">Â« 10å¹´å‰</button>
    <button class="btn btn-primary" id="playPause">
      <span id="playIcon">â–¶</span> <span id="playText">å†ç”Ÿ</span>
    </button>
    <button class="btn" id="nextDecade">10å¹´å¾Œ Â»</button>
    <button class="btn" id="nextCentury">100å¹´å¾Œ Â»</button>
    
    <div class="timeline-speed">
      <button class="btn" data-speed="slow">ä½é€Ÿ</button>
      <button class="btn active" data-speed="normal">æ¨™æº–</button>
      <button class="btn" data-speed="fast">é«˜é€Ÿ</button>
    </div>
  </div>
</div>

<!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="tutorialModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ“ ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
      <button class="close-btn" id="closeTutorial">âœ•</button>
    </div>
    
    <div class="tutorial-step">
      <h3>1. åœ°å›³ã®æ“ä½œ</h3>
      <p>ãƒã‚¦ã‚¹ãƒ‰ãƒ©ãƒƒã‚°ã¾ãŸã¯ã‚¿ãƒƒãƒã§åœ°å›³ã‚’ç§»å‹•ã§ãã¾ã™ã€‚ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã¾ãŸã¯ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆã—ã¾ã™ã€‚</p>
    </div>
    
    <div class="tutorial-step">
      <h3>2. å¹´ä»£ã®å¤‰æ›´</h3>
      <p>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã€ã¾ãŸã¯å†ç”Ÿãƒœã‚¿ãƒ³ã§æ­´å²ã‚’è‡ªå‹•çš„ã«é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¹´ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ç‰¹å®šã®æ™‚ä»£ã«ã‚¸ãƒ£ãƒ³ãƒ—ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p>
    </div>
    
    <div class="tutorial-step">
      <h3>3. æƒ…å ±ã®è¡¨ç¤º</h3>
      <p>åœ°å›³ä¸Šã®å›½ã‚„åœ°åŸŸã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®æ™‚ä»£ã®è©³ç´°æƒ…å ±ã€æ”¯é…è€…ã€é‡è¦ãªå‡ºæ¥äº‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>
    
    <div class="tutorial-step">
      <h3>4. ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</h3>
      <p>èˆˆå‘³æ·±ã„å¹´ä»£ã‚’è¦‹ã¤ã‘ãŸã‚‰ã€ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒœã‚¿ãƒ³ã§ä¿å­˜ã§ãã¾ã™ã€‚å¾Œã‹ã‚‰ç°¡å˜ã«ãã®æ™‚ä»£ã«æˆ»ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
    </div>
    
    <div class="tutorial-step">
      <h3>5. æ¤œç´¢æ©Ÿèƒ½</h3>
      <p>ç‰¹å®šã®å›½ã€ç‹æœã€äººç‰©ã‚’æ¤œç´¢ã—ã¦ã€ãã®å­˜åœ¨ã—ãŸæ™‚ä»£ã«ã™ã°ã‚„ãç§»å‹•ã§ãã¾ã™ã€‚</p>
    </div>
    
    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="startExploring">
      æ¢ç´¢ã‚’å§‹ã‚ã‚‹ ğŸš€
    </button>
  </div>
</div>

<!-- ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="bookmarkModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">ğŸ”– ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯</h2>
      <button class="close-btn" id="closeBookmark">âœ•</button>
    </div>
    <div id="bookmarkList"></div>
  </div>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div>èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— -->
<div class="tooltip" id="tooltip"></div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
const state = {
  year: -4000,
  zoom: 1,
  lang: 'ja',
  mapX: 2500,
  mapY: 580,
  isDragging: false,
  isPlaying: false,
  playSpeed: 1,
  bookmarks: [],
  dragStartX: 0,
  dragStartY: 0
};

const MAX_YEAR = 2019;
const MIN_YEAR = -4000;

// è¦ç´ å–å¾—
const yearDisplay = document.getElementById('yearDisplay');
const yearSub = document.getElementById('yearSub');
const yearInput = document.getElementById('yearInput');
const jumpToYear = document.getElementById('jumpToYear');
const zoomIn = document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomSlider = document.getElementById('zoomSlider');
const zoomThumb = document.getElementById('zoomThumb');
const zoomFill = document.getElementById('zoomFill');
const searchInput = document.getElementById('searchInput');
const bookmarkBtn = document.getElementById('bookmarkBtn');
const helpBtn = document.getElementById('helpBtn');
const mapContainer = document.getElementById('mapContainer');
const timelineBar = document.getElementById('timelineBar');
const timelineCursor = document.getElementById('timelineCursor');
const playPauseBtn = document.getElementById('playPause');
const playIcon = document.getElementById('playIcon');
const playText = document.getElementById('playText');
const tutorialModal = document.getElementById('tutorialModal');
const bookmarkModal = document.getElementById('bookmarkModal');
const loading = document.getElementById('loading');

// å¹´ä»£ã‚¯ãƒ©ãƒ³ãƒ—
function clampYear(y) {
  if (y < MIN_YEAR) return MIN_YEAR;
  if (y === 0) return 1;
  if (y > MAX_YEAR) return MAX_YEAR;
  return Math.round(y);
}

// å¹´ä»£ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatYear(y) {
  if (state.lang === 'en') {
    return y < 0 ? `${Math.abs(y)} BC` : `AD ${y}`;
  } else if (state.lang === 'zh') {
    return y < 0 ? `å‰${Math.abs(y)}å¹´` : `${y}å¹´`;
  }
  return y < 0 ? `å‰${Math.abs(y)}å¹´` : `${y}å¹´`;
}

// ä¸–ç´€è¡¨ç¤º
function getCentury(y) {
  if (state.lang !== 'en') return '';
  const century = Math.floor((Math.abs(y) - 1) / 100) + 1;
  const suffixes = ['th', 'st', 'nd', 'rd'];
  const v = century % 100;
  const suffix = (v >= 11 && v <= 13) ? 'th' : suffixes[v % 10] || 'th';
  return y < 0 ? `${century}${suffix} century BC` : `${century}${suffix} century`;
}

// è¡¨ç¤ºæ›´æ–°
function updateDisplay() {
  yearDisplay.textContent = formatYear(state.year);
  yearSub.textContent = getCentury(state.year);
  
  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®
  const totalRange = MAX_YEAR - MIN_YEAR;
  const position = (state.year - MIN_YEAR) / totalRange * 100;
  timelineCursor.style.left = position + '%';
  
  // ã‚ºãƒ¼ãƒ è¡¨ç¤º
  const zoomPercent = (state.zoom / 4) * 100;
  zoomFill.style.width = zoomPercent + '%';
  zoomThumb.style.left = `calc(${zoomPercent}% - 8px)`;
}

// å¹´ä»£å¤‰æ›´
function setYear(y) {
  state.year = clampYear(y);
  updateDisplay();
}

// ã‚ºãƒ¼ãƒ å¤‰æ›´
function setZoom(z) {
  state.zoom = Math.max(0, Math.min(4, z));
  updateDisplay();
}

// è¨€èªåˆ‡ã‚Šæ›¿ãˆ
document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.lang = btn.dataset.lang;
    updateDisplay();
    
    // ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
    if (state.lang === 'ja') {
      playText.textContent = state.isPlaying ? 'ä¸€æ™‚åœæ­¢' : 'å†ç”Ÿ';
      document.getElementById('bookmarkIcon').textContent = 'ğŸ”–';
    } else if (state.lang === 'en') {
      playText.textContent = state.isPlaying ? 'Pause' : 'Play';
    } else {
      playText.textContent = state.isPlaying ? 'æš‚åœ' : 'æ’­æ”¾';
    }
  });
});

// å¹´ä»£å…¥åŠ›
jumpToYear.addEventListener('click', () => {
  const y = parseInt(yearInput.value);
  if (!isNaN(y)) {
    setYear(y);
  }
});

yearInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    jumpToYear.click();
  }
});

// ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³
zoomIn.addEventListener('click', () => setZoom(state.zoom + 1));
zoomOut.addEventListener('click', () => setZoom(state.zoom - 1));

// ã‚ºãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
let zoomDragging = false;

zoomSlider.addEventListener('mousedown', (e) => {
  zoomDragging = true;
  updateZoomFromMouse(e);
});

document.addEventListener('mousemove', (e) => {
  if (zoomDragging) {
    updateZoomFromMouse(e);
  }
});

document.addEventListener('mouseup', () => {
  zoomDragging = false;
});

function updateZoomFromMouse(e) {
  const rect = zoomSlider.getBoundingClientRect();
  const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
  setZoom(Math.round(percent * 4));
}

// ãƒãƒƒãƒ—ãƒ‰ãƒ©ãƒƒã‚°
mapContainer.addEventListener('mousedown', (e) => {
  state.isDragging = true;
  state.dragStartX = e.clientX;
  state.dragStartY = e.clientY;
  mapContainer.classList.add('dragging');
});

document.addEventListener('mousemove', (e) => {
  if (state.isDragging) {
    const dx = e.clientX - state.dragStartX;
    const dy = e.clientY - state.dragStartY;
    state.mapX -= dx;
    state.mapY -= dy;
    state.dragStartX = e.clientX;
    state.dragStartY = e.clientY;
  }
});

document.addEventListener('mouseup', () => {
  state.isDragging = false;
  mapContainer.classList.remove('dragging');
});

// ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ 
mapContainer.addEventListener('wheel', (e) => {
  e.preventDefault();
  if (e.deltaY < 0) {
    setZoom(state.zoom + 1);
  } else {
    setZoom(state.zoom - 1);
  }
});

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¯ãƒªãƒƒã‚¯
timelineBar.addEventListener('click', (e) => {
  const rect = timelineBar.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / rect.width;
  const y = MIN_YEAR + percent * (MAX_YEAR - MIN_YEAR);
  setYear(y);
});

// å†ç”Ÿ/ä¸€æ™‚åœæ­¢
let playInterval;

playPauseBtn.addEventListener('click', () => {
  state.isPlaying = !state.isPlaying;
  
  if (state.isPlaying) {
    playIcon.textContent = 'â¸';
    playText.textContent = state.lang === 'ja' ? 'ä¸€æ™‚åœæ­¢' : state.lang === 'en' ? 'Pause' : 'æš‚åœ';
    
    playInterval = setInterval(() => {
      let increment = 1;
      if (state.year < -1000) increment = 100;
      else if (state.year < 0) increment = 50;
      else if (state.year < 1000) increment = 10;
      
      increment *= state.playSpeed;
      
      if (state.year >= MAX_YEAR) {
        state.isPlaying = false;
        clearInterval(playInterval);
        playIcon.textContent = 'â–¶';
        playText.textContent = state.lang === 'ja' ? 'å†ç”Ÿ' : 'Play';
        return;
      }
      
      setYear(state.year + increment);
    }, 200 / state.playSpeed);
  } else {
    clearInterval(playInterval);
    playIcon.textContent = 'â–¶';
    playText.textContent = state.lang === 'ja' ? 'å†ç”Ÿ' : state.lang === 'en' ? 'Play' : 'æ’­æ”¾';
  }
});

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
document.getElementById('prevCentury').addEventListener('click', () => setYear(state.year - 100));
document.getElementById('prevDecade').addEventListener('click', () => setYear(state.year - 10));
document.getElementById('nextDecade').addEventListener('click', () => setYear(state.year + 10));
document.getElementById('nextCentury').addEventListener('click', () => setYear(state.year + 100));

// å†ç”Ÿé€Ÿåº¦
document.querySelectorAll('[data-speed]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('[data-speed]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const speed = btn.dataset.speed;
    state.playSpeed = speed === 'slow' ? 0.5 : speed === 'fast' ? 2 : 1;
  });
});

// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
bookmarkBtn.addEventListener('click', () => {
  const existing = state.bookmarks.findIndex(b => b.year === state.year);
  
  if (existing >= 0) {
    state.bookmarks.splice(existing, 1);
    showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  } else {
    state.bookmarks.push({
      year: state.year,
      label: formatYear(state.year)
    });
    showNotification('ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«è¿½åŠ ã—ã¾ã—ãŸ');
  }
  
  updateBookmarkIcon();
});

function updateBookmarkIcon() {
  const isBookmarked = state.bookmarks.some(b => b.year === state.year);
  document.getElementById('bookmarkIcon').textContent = isBookmarked ? 'âœ“' : 'ğŸ”–';
}

// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒªã‚¹ãƒˆè¡¨ç¤º
function showBookmarks() {
  const list = document.getElementById('bookmarkList');
  
  if (state.bookmarks.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
  } else {
    list.innerHTML = state.bookmarks.map((b, i) => `
      <div class="bookmark-item" onclick="jumpToBookmark(${i})">
        <span>${b.label}</span>
        <button class="btn" onclick="event.stopPropagation(); deleteBookmark(${i})" style="padding: 4px 8px;">å‰Šé™¤</button>
      </div>
    `).join('');
  }
  
  bookmarkModal.classList.add('show');
}

function jumpToBookmark(index) {
  setYear(state.bookmarks[index].year);
  bookmarkModal.classList.remove('show');
}

function deleteBookmark(index) {
  state.bookmarks.splice(index, 1);
  showBookmarks();
}

window.jumpToBookmark = jumpToBookmark;
window.deleteBookmark = deleteBookmark;

// é€šçŸ¥è¡¨ç¤º
function showNotification(message) {
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: rgba(102, 126, 234, 0.95);
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 2000;
    animation: slideIn 0.3s ease;
  `;
  notif.textContent = message;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notif.remove(), 300);
  }, 2000);
}

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
`;
document.head.appendChild(style);

// ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³
helpBtn.addEventListener('click', () => {
  tutorialModal.classList.add('show');
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
document.getElementById('closeTutorial').addEventListener('click', () => {
  tutorialModal.classList.remove('show');
});

document.getElementById('startExploring').addEventListener('click', () => {
  tutorialModal.classList.remove('show');
  showNotification('æ¢ç´¢ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼ğŸ‰');
});

document.getElementById('closeBookmark').addEventListener('click', () => {
  bookmarkModal.classList.remove('show');
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
tutorialModal.addEventListener('click', (e) => {
  if (e.target === tutorialModal) {
    tutorialModal.classList.remove('show');
  }
});

bookmarkModal.addEventListener('click', (e) => {
  if (e.target === bookmarkModal) {
    bookmarkModal.classList.remove('show');
  }
});

// æ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒ‡ãƒ¢ï¼‰
searchInput.addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase();
  if (query.length < 2) return;
  
  // ç°¡æ˜“æ¤œç´¢ãƒ‡ãƒ¢
  const keywords = {
    'ãƒ­ãƒ¼ãƒ': -27,
    'rome': -27,
    'ç§¦': -221,
    'qin': -221,
    'æ¼¢': -206,
    'han': -206,
    'å”': 618,
    'tang': 618,
    'ãƒ¢ãƒ³ã‚´ãƒ«': 1206,
    'mongol': 1206,
    'ã‚ªã‚¹ãƒãƒ³': 1299,
    'ottoman': 1299,
    'æ˜': 1368,
    'ming': 1368,
    'æ¸…': 1644,
    'qing': 1644,
    'æ±Ÿæˆ¸': 1603,
    'edo': 1603,
    'å¾³å·': 1603,
    'tokugawa': 1603,
    'ãƒŠãƒãƒ¬ã‚ªãƒ³': 1804,
    'napoleon': 1804,
    'ã‚¢ãƒ¡ãƒªã‚«': 1776,
    'america': 1776
  };
  
  for (const [key, year] of Object.entries(keywords)) {
    if (key.includes(query)) {
      // ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
      showTooltip(searchInput, `Enter ã‚­ãƒ¼ã§ ${formatYear(year)} ã«ç§»å‹•`);
      
      searchInput.addEventListener('keypress', function handler(e) {
        if (e.key === 'Enter') {
          setYear(year);
          searchInput.value = '';
          hideTooltip();
          showNotification(`${key} ã®æ™‚ä»£ã«ç§»å‹•ã—ã¾ã—ãŸ`);
          searchInput.removeEventListener('keypress', handler);
        }
      });
      break;
    }
  }
});

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
const tooltip = document.getElementById('tooltip');

function showTooltip(element, text) {
  tooltip.textContent = text;
  tooltip.classList.add('show');
  
  const rect = element.getBoundingClientRect();
  tooltip.style.left = rect.left + 'px';
  tooltip.style.top = (rect.bottom + 5) + 'px';
}

function hideTooltip() {
  tooltip.classList.remove('show');
}

// ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆ
let touchStartX = 0;
let touchStartY = 0;

mapContainer.addEventListener('touchstart', (e) => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  state.isDragging = true;
});

mapContainer.addEventListener('touchmove', (e) => {
  if (state.isDragging) {
    e.preventDefault();
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;
    state.mapX -= dx;
    state.mapY -= dy;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }
});

mapContainer.addEventListener('touchend', () => {
  state.isDragging = false;
});

// ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ 
let initialDistance = 0;

mapContainer.addEventListener('touchstart', (e) => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    initialDistance = Math.sqrt(dx * dx + dy * dy);
  }
});

mapContainer.addEventListener('touchmove', (e) => {
  if (e.touches.length === 2) {
    e.preventDefault();
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    if (initialDistance > 0) {
      const scale = distance / initialDistance;
      if (scale > 1.1) {
        setZoom(state.zoom + 1);
        initialDistance = distance;
      } else if (scale < 0.9) {
        setZoom(state.zoom - 1);
        initialDistance = distance;
      }
    }
  }
});

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
document.addEventListener('keydown', (e) => {
  // çŸ¢å°ã‚­ãƒ¼ã§å¹´ä»£ç§»å‹•
  if (e.key === 'ArrowLeft') {
    e.preventDefault();
    setYear(state.year - 10);
  } else if (e.key === 'ArrowRight') {
    e.preventDefault();
    setYear(state.year + 10);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    setYear(state.year + 100);
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    setYear(state.year - 100);
  }
  
  // ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§å†ç”Ÿ/ä¸€æ™‚åœæ­¢
  if (e.key === ' ' && e.target.tagName !== 'INPUT') {
    e.preventDefault();
    playPauseBtn.click();
  }
  
  // +/- ã§ã‚ºãƒ¼ãƒ 
  if (e.key === '+' || e.key === '=') {
    e.preventDefault();
    setZoom(state.zoom + 1);
  } else if (e.key === '-') {
    e.preventDefault();
    setZoom(state.zoom - 1);
  }
  
  // B ã§ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯
  if (e.key === 'b' || e.key === 'B') {
    if (e.target.tagName !== 'INPUT') {
      e.preventDefault();
      bookmarkBtn.click();
    }
  }
  
  // H ã§ãƒ˜ãƒ«ãƒ—
  if (e.key === 'h' || e.key === 'H') {
    if (e.target.tagName !== 'INPUT') {
      e.preventDefault();
      helpBtn.click();
    }
  }
  
  // ESC ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  if (e.key === 'Escape') {
    tutorialModal.classList.remove('show');
    bookmarkModal.classList.remove('show');
  }
});

// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºãƒ‡ãƒ¢
function showLoading() {
  loading.classList.add('show');
}

function hideLoading() {
  loading.classList.remove('show');
}

// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ãƒœã‚¿ãƒ³ã«ãƒªã‚¹ãƒˆè¡¨ç¤ºæ©Ÿèƒ½ã‚’è¿½åŠ 
bookmarkBtn.addEventListener('contextmenu', (e) => {
  e.preventDefault();
  showBookmarks();
});

bookmarkBtn.addEventListener('dblclick', () => {
  showBookmarks();
});

// åˆæœŸåŒ–æ™‚ã«ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¡¨ç¤º
window.addEventListener('load', () => {
  // åˆå›è¨ªå•ã‹ãƒã‚§ãƒƒã‚¯
  const hasVisited = localStorage.getItem('hasVisited');
  if (!hasVisited) {
    setTimeout(() => {
      tutorialModal.classList.add('show');
      localStorage.setItem('hasVisited', 'true');
    }, 500);
  }
  
  updateDisplay();
  updateBookmarkIcon();
  
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’èª­ã¿è¾¼ã¿
  const savedBookmarks = localStorage.getItem('bookmarks');
  if (savedBookmarks) {
    try {
      state.bookmarks = JSON.parse(savedBookmarks);
    } catch (e) {
      console.error('Failed to load bookmarks');
    }
  }
});

// ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’ä¿å­˜
window.addEventListener('beforeunload', () => {
  localStorage.setItem('bookmarks', JSON.stringify(state.bookmarks));
});

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    updateDisplay();
  }, 250);
});

// å¹´ä»£ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
const originalSetYear = setYear;
setYear = function(y) {
  originalSetYear(y);
  updateBookmarkIcon();
};

// ãƒ›ãƒãƒ¼ãƒ’ãƒ³ãƒˆ
const hintElements = [
  { el: zoomSlider, text: 'ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã‚ºãƒ¼ãƒ èª¿æ•´' },
  { el: timelineBar, text: 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¹´ä»£ã«ã‚¸ãƒ£ãƒ³ãƒ—' },
  { el: searchInput, text: 'å›½åãƒ»äººç‰©åã§æ¤œç´¢ï¼ˆä¾‹: ãƒ­ãƒ¼ãƒã€å”ã€ãƒŠãƒãƒ¬ã‚ªãƒ³ï¼‰' },
  { el: playPauseBtn, text: 'ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚‚æ“ä½œå¯èƒ½' }
];

hintElements.forEach(({ el, text }) => {
  el.addEventListener('mouseenter', () => {
    showTooltip(el, text);
  });
  
  el.addEventListener('mouseleave', () => {
    hideTooltip();
  });
});

</script>

</body>
</html>